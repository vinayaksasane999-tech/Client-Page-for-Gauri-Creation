<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order • Gauri Creations</title>

<link rel="icon" href="favicon.ico">
<link rel="apple-touch-icon" href="favicon.ico">

<style>
body{
  margin:0;
  font-family:Poppins,system-ui;
  background:linear-gradient(135deg,#86e1ff,#ffd4b8);
  padding:20px;
}
.container{
  max-width:520px;
  margin:auto;
  background:#ffffffee;
  padding:25px;
  border-radius:22px;
  box-shadow:0 10px 25px rgba(0,0,0,.2);
  text-align:center;
}
.logo{
  width:130px;
  margin:0 auto 20px;
  border-radius:12px;
}
.product-box{
  display:flex;
  gap:12px;
  align-items:center;
  margin-bottom:18px;
  text-align:left;
}
.product-img{
  width:95px;
  height:95px;
  border-radius:15px;
  object-fit:cover;
}
.qty-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:16px auto;
  width:92%;
}
.qty-btn{
  padding:8px 16px;
  border-radius:10px;
  background:#007aff;
  color:white;
  border:none;
  font-size:18px;
  font-weight:600;
}
.input-field{
  width:92%;
  margin:12px auto 0;
  display:block;
  padding:13px;
  border-radius:12px;
  border:1px solid #bbb;
  font-size:15px;
}
.summary{
  background:#fff;
  border-radius:14px;
  border:1px solid #ddd;
  padding:14px;
  margin:18px auto 0;
  width:92%;
  text-align:left;
}
.btn-proceed{
  width:92%;
  padding:14px;
  background:#007aff;
  color:white;
  border-radius:14px;
  font-size:17px;
  font-weight:600;
  margin-top:18px;
  border:none;
}
</style>
</head>

<body>

<div class="container">

<img src="logo-gauri.jpeg" class="logo">

<h2>Order Details</h2>

<div class="product-box">
  <img id="prodImg" class="product-img">
  <div>
    <div id="prodName" style="font-size:18px;font-weight:600;">Loading…</div>
    <div id="prodPrice" style="color:#c62828;font-weight:600;">₹0</div>
    <div id="prodWeight" style="font-size:13px;color:#666;">Weight: -</div>
  </div>
</div>

<div class="qty-row">
  <button id="minusBtn" class="qty-btn">−</button>
  <div><strong>Quantity:</strong> <span id="qty">1</span></div>
  <button id="plusBtn" class="qty-btn">+</button>
</div>

<input id="custName" class="input-field" placeholder="Your Full Name">
<input id="custPhone" class="input-field" placeholder="Phone Number">
<input id="custPincode" class="input-field" placeholder="Pincode (6 digits)">
<textarea id="custAddress" class="input-field" rows="3" placeholder="Full Delivery Address"></textarea>
<textarea id="custNotes" class="input-field" rows="2" placeholder="Notes (optional)"></textarea>

<div class="summary">
  <div><strong>Price:</strong> ₹<span id="sumPrice">0</span></div>
  <div><strong>Delivery:</strong> ₹<span id="sumDelivery">0</span></div>
  <div><strong>Total:</strong> ₹<span id="sumTotal">0</span></div>
  <div><strong>Expected Delivery:</strong> <span id="deliveryDate">-</span></div>
</div>

<button id="proceedBtn" class="btn-proceed">Proceed to Payment</button>

</div>

<script>
/* ================= CONFIG ================= */
const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbyNznWMbvHaiu7PjF-Kz5i35E1cNq5FobRnjJ2pAWcmhCL42R8f7A_WXxQUkQebdDE/exec";

/* ================= STATE ================= */
let qty = 1;
let price = 0;
let weight = 0;
let productName = "";

/* ================= DOM ================= */
const qtyEl = document.getElementById("qty");
const sumPriceEl = document.getElementById("sumPrice");
const sumDeliveryEl = document.getElementById("sumDelivery");
const sumTotalEl = document.getElementById("sumTotal");
const deliveryDateEl = document.getElementById("deliveryDate");

const pincodeEl = document.getElementById("custPincode");
const nameEl = document.getElementById("custName");
const phoneEl = document.getElementById("custPhone");
const addressEl = document.getElementById("custAddress");
const notesEl = document.getElementById("custNotes");

/* ================= SHIPPING ================= */
function shippingByWeight(g){
  if(g<=250) return 49;
  if(g<=500) return 59;
  if(g<=1000) return 79;
  return 79 + Math.ceil((g-1000)/500)*30;
}

/* ================= SUMMARY ================= */
function updateSummary(){
  if(!price) return;
  const subtotal = price * qty;
  const pin = pincodeEl.value.trim();
  const delivery = /^\d{6}$/.test(pin) ? shippingByWeight(weight*qty) : 0;
  const total = subtotal + delivery;

  qtyEl.textContent = qty;
  sumPriceEl.textContent = subtotal;
  sumDeliveryEl.textContent = delivery;
  sumTotalEl.textContent = total;

  const d = new Date();
  d.setDate(d.getDate()+7);
  deliveryDateEl.textContent = d.toDateString();
}

/* ================= EVENTS ================= */
document.getElementById("plusBtn").addEventListener("click",()=>{
  qty++; updateSummary();
});
document.getElementById("minusBtn").addEventListener("click",()=>{
  qty = Math.max(1,qty-1); updateSummary();
});
pincodeEl.addEventListener("input",updateSummary);

/* ================= LOAD PRODUCT ================= */
(async ()=>{
  try{
    const sku = new URLSearchParams(location.search).get("sku");
    if(!sku) throw "No SKU";

    const r = await fetch(`${SCRIPT_URL}?action=getProduct&sku=${encodeURIComponent(sku)}`);
    const d = await r.json();
    if(!d.success) throw "Invalid product";

    const p = d.product;
    productName = p["Name"];
    price = Number(p["Price"]);
    weight = Number(p["Weight"]||0);

    prodName.textContent = productName;
    prodPrice.textContent = "₹"+price;
    prodImg.src = p["Image URL 1"];
    prodWeight.textContent = `Weight: ${weight} g`;

    updateSummary();
  }catch{
    alert("Unable to load product. Please reopen the link.");
  }
})();

/* ================= SUBMIT ================= */
document.getElementById("proceedBtn").addEventListener("click",async ()=>{
  if(!nameEl.value || !phoneEl.value || !addressEl.value || !/^\d{6}$/.test(pincodeEl.value)){
    alert("Please fill all required fields");
    return;
  }

  const orderId = "GC"+Date.now();
  const subtotal = price * qty;
  const delivery = shippingByWeight(weight*qty);

  await fetch(SCRIPT_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"createOrder",
      orderId,
      product:productName,
      qty,
      price,
      subtotal,
      delivery,
      total:subtotal+delivery,
      name:nameEl.value,
      phone:phoneEl.value,
      address:addressEl.value,
      pincode:pincodeEl.value,
      notes:notesEl.value,
      status:"PENDING"
    })
  });

  location.href =
   `payment.html?orderId=${orderId}&product=${encodeURIComponent(productName)}&price=${subtotal}&qty=${qty}&delivery=${delivery}`;
});
</script>

</body>
</html>