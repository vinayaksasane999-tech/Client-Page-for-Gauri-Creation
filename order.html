<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order • Gauri Creations</title>

<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="favicon.ico">

<style>
body { margin: 0; font-family: "Poppins", sans-serif; background: linear-gradient(135deg, #86e1ff, #ffd4b8); padding: 20px; color: #222; }
.container { max-width: 520px; margin: auto; background: #ffffffd8; padding: 25px; border-radius: 22px; backdrop-filter: blur(10px); box-shadow: 0 6px 18px rgba(0,0,0,0.18); text-align: center; }
.logo { width: 130px; display: block; margin: 0 auto 20px; border-radius: 12px; }
.product-box { display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 18px; text-align: left; }
.product-img { width: 95px; height: 95px; border-radius: 15px; object-fit: cover; }
.input-field { width: 92%; margin: 12px auto 0; display: block; padding: 13px; border-radius: 12px; border: 1px solid #bbb; font-size: 15px; background:white; }
.summary { background: #fff; padding: 14px; border-radius: 15px; border: 1px solid #ddd; width: 92%; margin: 18px auto 0; text-align: left; }
.summary div { font-size: 15px; margin-bottom: 6px; }
.btn-proceed { width: 92%; padding: 14px; background: #007aff; color: white; border-radius: 14px; font-size: 17px; font-weight: 600; margin: 18px auto 0; border: none; display: block; cursor:pointer; }
.qty-row { width: 92%; margin: 18px auto 14px; display: flex; justify-content: space-between; align-items: center; }
.qty-btn { padding: 8px 16px; border-radius: 10px; background: #007aff; color: white; border: none; font-size: 18px; font-weight: 600; cursor:pointer; }
</style>
</head>

<body>

<div class="container">

<img src="logo-gauri.jpeg" class="logo">

<h2>Order Details</h2>

<div class="product-box">
  <img id="prodImg" class="product-img">
  <div>
    <div id="prodName" style="font-size:18px;font-weight:600;">Product</div>
    <div id="prodPrice" style="font-weight:600; color:#c62828;">₹0</div>
    <div id="prodWeight" style="font-size:13px;color:#666;">Weight: - g</div>
  </div>
</div>

<div class="qty-row">
  <button type="button" class="qty-btn" onclick="updateQty(-1)">−</button>
  <div><strong>Quantity:</strong> <span id="qty">1</span></div>
  <button type="button" class="qty-btn" onclick="updateQty(1)">+</button>
</div>

<input id="custName" class="input-field" placeholder="Your Full Name">
<input id="custPhone" class="input-field" placeholder="Phone Number">
<input id="custPincode" class="input-field" placeholder="Pincode (6 digits)">
<textarea id="custAddress" class="input-field" rows="3" placeholder="Full Delivery Address"></textarea>
<textarea id="custNotes" class="input-field" rows="2" placeholder="Notes (optional)"></textarea>

<div class="summary">
  <div><strong>Price:</strong> ₹<span id="sumPrice">0</span></div>
  <div><strong>Delivery Charges:</strong> ₹<span id="sumDelivery">0</span></div>
  <div><strong>Total Amount:</strong> ₹<span id="sumTotal">0</span></div>
  <div><strong>Expected Delivery:</strong> <span id="deliveryDate">-</span></div>
</div>

<button type="button" class="btn-proceed" onclick="submitOrder(event)">Proceed to Payment</button>

</div>

<script>
const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbwhyOU_ee33OYs_jowKaqvspE5ejvXhF6uJYa2l5C_Y9Fs7-zJ31P4arUh796000SCC/exec";

/* DOM */
const qtyEl = document.getElementById("qty");
const sumPriceEl = document.getElementById("sumPrice");
const sumDeliveryEl = document.getElementById("sumDelivery");
const sumTotalEl = document.getElementById("sumTotal");
const deliveryDateEl = document.getElementById("deliveryDate");

const custNameEl = document.getElementById("custName");
const custPhoneEl = document.getElementById("custPhone");
const custPincodeEl = document.getElementById("custPincode");
const custAddressEl = document.getElementById("custAddress");
const custNotesEl = document.getElementById("custNotes");

/* STATE */
let qty = 1;
let prodName = "";
let prodPrice = 0;
let weightPerItem = 0;

/* SHIPPING */
function shippingByWeight(g){
  if(g <= 250) return 49;
  if(g <= 500) return 59;
  if(g <= 1000) return 79;
  return 79 + Math.ceil((g - 1000) / 500) * 30;
}

/* SUMMARY */
function updateSummary(){
  if(!prodPrice) return;

  const subtotal = prodPrice * qty;
  const pin = custPincodeEl.value.trim();
  const delivery = /^\d{6}$/.test(pin)
    ? shippingByWeight(weightPerItem * qty)
    : 0;

  const total = subtotal + delivery;

  qtyEl.textContent = qty;
  sumPriceEl.textContent = subtotal;
  sumDeliveryEl.textContent = delivery;
  sumTotalEl.textContent = total;

  const d = new Date();
  d.setDate(d.getDate() + 7);
  deliveryDateEl.textContent = d.toDateString();
}

function updateQty(v){
  qty = Math.max(1, qty + v);
  updateSummary();
}

/* LOAD PRODUCT */
const sku = new URLSearchParams(window.location.search).get("sku");

fetch(`${SCRIPT_URL}?action=getProduct&sku=${encodeURIComponent(sku)}`)
.then(r => r.json())
.then(d => {
  if(!d.success || !d.product){
    alert("Product not found");
    return;
  }

  const p = d.product;
  prodName = p["Name"];
  prodPrice = Number(p["Price"]);
  weightPerItem = Number(p["Weight"] || 0);

  document.getElementById("prodName").textContent = prodName;
  document.getElementById("prodPrice").textContent = "₹" + prodPrice;
  document.getElementById("prodImg").src = p["Image URL 1"];
  document.getElementById("prodWeight").textContent =
    `Weight: ${weightPerItem} g`;

  updateSummary();
});

custPincodeEl.addEventListener("input", updateSummary);

/* =========================
   FORM-BASED ORDER SUBMIT
   (CORS SAFE)
   ========================= */
async function submitOrder(event){
  if(event) event.preventDefault(); // ✅ STOP form submission

  const name = custNameEl.value.trim();
  const phone = custPhoneEl.value.trim();
  const address = custAddressEl.value.trim();
  const pin = custPincodeEl.value.trim();

  if(!name || !phone || !address || !/^\d{6}$/.test(pin)){
    alert("Please fill all required fields");
    return;
  }

  const subtotal = prodPrice * qty;
  const delivery = shippingByWeight(weightPerItem * qty);
  const total = subtotal + delivery;

  const form = new FormData();
  form.append("action","createOrder");
  form.append("product",prodName);
  form.append("qty",qty);
  form.append("price",prodPrice);
  form.append("subtotal",subtotal);
  form.append("delivery",delivery);
  form.append("total",total);
  form.append("name",name);
  form.append("phone",phone);
  form.append("address",address);
  form.append("pincode",pin);
  form.append("notes",custNotesEl.value || "");

  try{
    const res = await fetch(SCRIPT_URL,{
      method:"POST",
      body:form
    });

    const data = await res.json();

    if(!data.success){
      alert("Order failed. Please try again.");
      return;
    }

    // ✅ FRONTEND REDIRECT (CORRECT)
    window.location.href =
      payment.html?orderId=${data.orderId};

  }catch(err){
    console.error(err);
    alert("Network error. Please try again.");
  }
}
</script>

</body>
</html>
