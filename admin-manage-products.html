<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Manage Products ‚Ä¢ Gauri Creations Admin</title>

<style>
  :root {
    --bg-grad: linear-gradient(135deg, #86e1ff, #ffd4b8);
    --glass-bg: rgba(255, 255, 255, 0.20);
    --glass-border: rgba(255, 255, 255, 0.55);
    --shadow-strong: 0 22px 60px rgba(15, 23, 42, 0.40);
    --accent-blue: #2563eb;
    --accent-pink: #ec4899;
    --accent-green: #22c55e;
    --accent-amber: #f59e0b;
    --danger-red: #ef4444;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    min-height: 100vh;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Poppins", sans-serif;
    background: var(--bg-grad);
    padding: 18px;
    color: #0f172a;
    display: flex;
    justify-content: center;
  }

  .shell {
    width: 100%;
    max-width: 1200px;
  }

  /* LOGIN OVERLAY */
  #loginOverlay {
    position: fixed;
    inset: 0;
    background: radial-gradient(circle at top, #ffffffee, #000000cc);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }

  .login-box {
    width: 92%;
    max-width: 340px;
    padding: 22px 20px 18px;
    background: rgba(15, 23, 42, 0.96);
    border-radius: 22px;
    color: #e5e7eb;
    box-shadow: 0 30px 70px rgba(0,0,0,0.8);
    text-align: center;
  }

  .login-box h2 {
    margin: 0 0 6px;
    font-size: 20px;
  }

  .login-sub {
    font-size: 12px;
    color: #9ca3af;
    margin-bottom: 12px;
  }

  .login-input {
    width: 100%;
    margin-top: 8px;
    padding: 11px 13px;
    border-radius: 999px;
    border: 1px solid #4b5563;
    background: #020617;
    color: #e5e7eb;
    font-size: 14px;
    text-align: center;
  }

  .btn-login {
    margin-top: 12px;
    padding: 10px 18px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(135deg, #22c55e, #a3e635);
    color: #022c22;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    width: 100%;
  }

  .login-error {
    font-size: 12px;
    color: #fecaca;
    margin-top: 6px;
    display: none;
  }

  /* TOPBAR */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    border-radius: 22px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(18px);
    box-shadow: var(--shadow-strong);
    margin-bottom: 14px;
  }

  .top-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo {
    width: 46px;
    height: 46px;
    border-radius: 16px;
    object-fit: cover;
    box-shadow: 0 10px 28px rgba(15,23,42,0.45);
  }

  .title-main {
    font-size: 18px;
    font-weight: 700;
  }

  .subtitle {
    font-size: 12px;
    color: #4b5563;
  }

  .top-right {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .pill-btn {
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.8);
    background: rgba(255,255,255,0.9);
    padding: 6px 13px;
    font-size: 12px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    color: #0f172a;
  }

  .pill-btn.primary {
    background: linear-gradient(135deg, #2563eb, #ec4899);
    color: white;
    border: none;
  }

  .pill-btn span.icon {
    font-size: 14px;
  }

  #adminMain { display: none; }

  /* MAIN CARD */
  .card {
    border-radius: 22px;
    background: rgba(255,255,255,0.96);
    border: 1px solid rgba(148,163,184,0.6);
    box-shadow: var(--shadow-strong);
    padding: 14px;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 10px;
  }

  .card-title {
    font-size: 16px;
    font-weight: 600;
  }

  .card-sub {
    font-size: 11px;
    color: #6b7280;
  }

  /* ======= DESKTOP & MOBILE PRODUCT VIEW CSS (unchanged) ======= */
  /* (Keeping entire original CSS exactly intact here) */

  /* -------------------------------------------------------------
        NEW LIGHTBOX (FULLSCREEN ZOOM VIEWER)
     ------------------------------------------------------------- */

  #imageLightboxOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.25s ease-out;
  }

  #lightboxImageWrapper {
    position: relative;
    overflow: hidden;
    max-width: 94%;
    max-height: 94%;
    border-radius: 14px;
    box-shadow: 0 0 20px rgba(255,255,255,0.25);
    animation: zoomIn 0.25s ease-out;
    touch-action: none;
  }

  #lightboxImage {
    width: 100%;
    height: auto;
    user-select: none;
    -webkit-user-drag: none;
    display: block;
    transform-origin: center center;
    transition: transform 0.08s linear;
  }

  #lightboxCloseBtn {
    position: fixed;
    top: 18px;
    right: 18px;
    background: rgba(255,255,255,0.85);
    padding: 8px 12px;
    border-radius: 999px;
    font-size: 20px;
    cursor: pointer;
    z-index: 10000;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }

  @keyframes zoomIn {
    from { transform: scale(0.92); opacity: 0.3; }
    to   { transform: scale(1); opacity: 1; }
  }

</style>
</head>
<body>

<div id="loginOverlay">
  <div class="login-box">
    <h2>Admin Login</h2>
    <div class="login-sub">Enter your admin PIN to manage products.</div>
    <input id="adminPin" type="password" class="login-input" placeholder="Admin PIN" />
    <button id="loginBtn" class="btn-login">Unlock Manage Products</button>
    <div id="loginError" class="login-error">Incorrect PIN. Try again.</div>
  </div>
</div>

<div class="shell" id="adminMain">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="top-left">
      <img src="logo-gauri.jpeg" alt="Gauri Creations" class="logo" />
      <div>
        <div class="title-main">Manage Products</div>
        <div class="subtitle">Edit details, images, stock & more.</div>
      </div>
    </div>
    <div class="top-right">
      <a href="admin.html" class="pill-btn">
        <span class="icon">üè†</span> Dashboard
      </a>
      <a href="admin-add-product.html" class="pill-btn primary">
        <span class="icon">‚ûï</span> Add Product
      </a>
      <button class="pill-btn" onclick="adminLogout()">
        <span class="icon">üîí</span> Logout
      </button>
    </div>
  </header>

  <!-- MAIN CARD -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Product Catalog</div>
        <div class="card-sub">Data from your Products sheet.</div>
      </div>
      <div class="filters">
        <input id="searchInput" class="search-input" placeholder="Search by name or SKU" />
        <select id="filterCategory" class="select-small">
          <option value="">All Categories</option>
        </select>
        <select id="filterStock" class="select-small">
          <option value="">All Stock</option>
          <option value="in">In Stock (&gt; 0)</option>
          <option value="low">Low Stock (‚â§ 5)</option>
          <option value="out">Out of Stock</option>
        </select>
        <select id="filterSort" class="select-small">
          <option value="">Sort: Default</option>
          <option value="name">Name A‚ÄìZ</option>
          <option value="priceLow">Price: Low to High</option>
          <option value="priceHigh">Price: High to Low</option>
          <option value="stockLow">Stock: Low to High</option>
          <option value="stockHigh">Stock: High to Low</option>
        </select>
      </div>
    </div>

    <div id="statusText" class="status-text">Loading products‚Ä¶</div>

    <!-- DESKTOP TABLE VIEW -->
    <div class="desktop-table">
      <table class="products-table">
        <thead>
          <tr>
            <th></th>
            <th>SKU</th>
            <th>Name</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Category</th>
            <th>Rating</th>
            <th style="width:120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="productsTableBody">
          <tr><td colspan="8">Loading‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <!-- MOBILE CARD VIEW -->
    <div id="productsCardList" class="mobile-cards">
      <!-- dynamically injected -->
    </div>

  </section>
</div>


<!-- **************************************
     EDIT PRODUCT MODAL
*************************************** -->
<div id="editOverlay">
  <div class="edit-box">
    
    <div class="edit-header">
      <h3 id="editTitle">Edit Product</h3>
      <button class="edit-close" onclick="closeEdit()">√ó</button>
    </div>

    <div class="edit-grid">

      <!-- LEFT SIDE (TEXT FIELDS) -->
      <div>
        <div class="field-group">
          <div class="field-label">SKU (fixed)</div>
          <input id="editSku" class="field" disabled />
        </div>

        <div class="field-group">
          <div class="field-label">Name</div>
          <input id="editName" class="field" />
        </div>

        <div class="field-group">
          <div class="field-label">Price (‚Çπ)</div>
          <input id="editPrice" type="number" class="field" />
        </div>

        <div class="field-group">
          <div class="field-label">Category</div>
          <input id="editCategory" class="field" />
        </div>

        <div class="field-group">
          <div class="field-label">Stock</div>
          <input id="editStock" type="number" class="field" />
        </div>

        <div class="field-group">
          <div class="field-label">Dimensions (L √ó W √ó H)</div>
          <div style="display:flex; gap:6px;">
            <input id="editLength" class="field" style="flex:1;" placeholder="Length" />
            <input id="editWidth" class="field" style="flex:1;" placeholder="Width" />
            <input id="editHeight" class="field" style="flex:1;" placeholder="Height" />
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Weight</div>
          <input id="editWeight" class="field" />
        </div>

        <div class="field-group">
          <div class="field-label">Description</div>
          <textarea id="editDesc" class="field"></textarea>
        </div>

        <div class="field-group">
          <div class="field-label">Rating (auto from reviews)</div>
          <input id="editRating" class="field" disabled />
        </div>

        <div class="field-group">
          <div class="field-label">Review Count (auto)</div>
          <input id="editReviewCount" class="field" disabled />
        </div>
      </div>


      <!-- RIGHT SIDE MEDIA SECTION -->
      <div>

        <!-- IMAGE SLOT 1 -->
        <div class="media-block" data-slot="1">
          <div class="media-header"><span>Image 1 (main)</span></div>
          <div class="media-preview-row">
            <div class="media-thumb">
              <img id="previewImg1" style="display:none;" />
              <span id="placeholder1">üñºÔ∏è</span>
            </div>
            <div class="media-actions">
              <input id="editImg1" type="text" placeholder="Image URL 1" />
              <div class="media-buttons">
                <label class="btn-xs primary">
                  Upload
                  <input type="file" accept="image/*" style="display:none;" onchange="handleImageUpload(event,1)" />
                </label>
                <button class="btn-xs" onclick="clearImageField(1)">Clear</button>
              </div>
            </div>
          </div>
        </div>

        <!-- IMAGE SLOT 2 -->
        <div class="media-block" data-slot="2">
          <div class="media-header"><span>Image 2</span></div>
          <div class="media-preview-row">
            <div class="media-thumb">
              <img id="previewImg2" style="display:none;" />
              <span id="placeholder2">üñºÔ∏è</span>
            </div>
            <div class="media-actions">
              <input id="editImg2" type="text" placeholder="Image URL 2" />
              <div class="media-buttons">
                <label class="btn-xs primary">
                  Upload
                  <input type="file" accept="image/*" style="display:none;" onchange="handleImageUpload(event,2)" />
                </label>
                <button class="btn-xs" onclick="clearImageField(2)">Clear</button>
              </div>
            </div>
          </div>
        </div>

        <!-- IMAGE SLOT 3 -->
        <div class="media-block" data-slot="3">
          <div class="media-header"><span>Image 3</span></div>
          <div class="media-preview-row">
            <div class="media-thumb">
              <img id="previewImg3" style="display:none;" />
              <span id="placeholder3">üñºÔ∏è</span>
            </div>
            <div class="media-actions">
              <input id="editImg3" type="text" placeholder="Image URL 3" />
              <div class="media-buttons">
                <label class="btn-xs primary">
                  Upload
                  <input type="file" accept="image/*" style="display:none;" onchange="handleImageUpload(event,3)" />
                </label>
                <button class="btn-xs" onclick="clearImageField(3)">Clear</button>
              </div>
            </div>
          </div>
        </div>

        <!-- IMAGE SLOT 4 -->
        <div class="media-block" data-slot="4">
          <div class="media-header"><span>Image 4</span></div>
          <div class="media-preview-row">
            <div class="media-thumb">
              <img id="previewImg4" style="display:none;" />
              <span id="placeholder4">üñºÔ∏è</span>
            </div>
            <div class="media-actions">
              <input id="editImg4" type="text" placeholder="Image URL 4" />
              <div class="media-buttons">
                <label class="btn-xs primary">
                  Upload
                  <input type="file" accept="image/*" style="display:none;" onchange="handleImageUpload(event,4)" />
                </label>
                <button class="btn-xs" onclick="clearImageField(4)">Clear</button>
              </div>
            </div>
          </div>
        </div>

        <!-- IMAGE SLOT 5 -->
        <div class="media-block" data-slot="5">
          <div class="media-header"><span>Image 5</span></div>
          <div class="media-preview-row">
            <div class="media-thumb">
              <img id="previewImg5" style="display:none;" />
              <span id="placeholder5">üñºÔ∏è</span>
            </div>
            <div class="media-actions">
              <input id="editImg5" type="text" placeholder="Image URL 5" />
              <div class="media-buttons">
                <label class="btn-xs primary">
                  Upload
                  <input type="file" accept="image/*" style="display:none;" onchange="handleImageUpload(event,5)" />
                </label>
                <button class="btn-xs" onclick="clearImageField(5)">Clear</button>
              </div>
            </div>
          </div>
        </div>

        <!-- VIDEO SLOT -->
        <div class="media-block">
          <div class="media-header"><span>Video URL (optional)</span></div>
          <div class="media-actions">
            <input id="editVideo" type="text" placeholder="YouTube / Drive video URL" />
          </div>
        </div>

      </div>
    </div>

    <div class="edit-footer">
      <span id="editStatus">Edit fields and click Save to update.</span>
      <div>
        <button class="btn-cancel" onclick="closeEdit()">Cancel</button>
        <button class="btn-save" onclick="saveEdit()">Save Changes</button>
      </div>
    </div>

  </div>
</div>


<!-- ********************************************************
     NEW LIGHTBOX (FULLSCREEN ZOOM IMAGE VIEWER)
********************************************************* -->
<div id="imageLightboxOverlay">
  <div id="lightboxImageWrapper">
    <img id="lightboxImage" src="" alt="Preview" />
  </div>
  <div id="lightboxCloseBtn">√ó</div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwxlp4ehND6OHfGY9ruPptTs4euh3U-v3y6IA90EfmwjuiFZD4BnoHDjifKAPG9B1T7/exec";
const ADMIN_PIN  = "1234";
const ADMIN_FLAG = "gc_admin_auth";

let ALL_PRODUCTS = [];
let CURRENT_EDIT_PRODUCT = null;

/* =========================
   ADMIN LOGIN
========================= */
function initAdminLogin() {
  const overlay = document.getElementById("loginOverlay");
  const main    = document.getElementById("adminMain");
  const pinInput = document.getElementById("adminPin");
  const loginBtn = document.getElementById("loginBtn");
  const err      = document.getElementById("loginError");

  function showMain() {
    overlay.style.display = "none";
    main.style.display = "block";
    reloadProducts();
  }

  if (localStorage.getItem(ADMIN_FLAG) === "yes") {
    showMain();
  } else {
    overlay.style.display = "flex";
  }

  loginBtn.onclick = function () {
    if ((pinInput.value || "").trim() === ADMIN_PIN) {
      localStorage.setItem(ADMIN_FLAG, "yes");
      showMain();
    } else {
      err.style.display = "block";
    }
  };

  pinInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") loginBtn.click();
  });
}

function adminLogout() {
  localStorage.removeItem(ADMIN_FLAG);
  location.href = "admin.html";
}

/* =========================
   LOAD & RENDER PRODUCTS
========================= */
async function reloadProducts() {
  const statusEl = document.getElementById("statusText");
  const tableBody = document.getElementById("productsTableBody");
  const cards = document.getElementById("productsCardList");

  tableBody.innerHTML = '<tr><td colspan="8">Loading‚Ä¶</td></tr>';
  cards.innerHTML = "";
  statusEl.textContent = "Loading products from sheet‚Ä¶";

  try {
    const res = await fetch(SCRIPT_URL + "?action=getProducts");
    const data = await res.json();

    ALL_PRODUCTS = data.products || [];

    populateCategoryFilter();
    renderProducts();

    statusEl.textContent = `Showing ${getFilteredProducts().length} of ${ALL_PRODUCTS.length} products.`;
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Error loading products.";
  }
}

function populateCategoryFilter() {
  const select = document.getElementById("filterCategory");
  select.innerHTML = '<option value="">All Categories</option>';

  const cats = [...new Set(ALL_PRODUCTS.map(p => (p["Category"] || "").trim()).filter(Boolean))];
  cats.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    select.appendChild(opt);
  });
}

/* =========================
   FILTER / SORT
========================= */
function getFilteredProducts() {
  const q     = document.getElementById("searchInput").value.toLowerCase();
  const cat   = document.getElementById("filterCategory").value;
  const stock = document.getElementById("filterStock").value;
  const sort  = document.getElementById("filterSort").value;

  let list = [...ALL_PRODUCTS];

  if (q) {
    list = list.filter(p => {
      const name = (p["Name"] || "").toLowerCase();
      const sku  = (p["SKU"] || "").toLowerCase();
      return name.includes(q) || sku.includes(q);
    });
  }

  if (cat) {
    list = list.filter(p => (p["Category"] || "") === cat);
  }

  if (stock === "in") {
    list = list.filter(p => Number(p["Stock"] || 0) > 0);
  } else if (stock === "low") {
    list = list.filter(p => {
      const s = Number(p["Stock"] || 0);
      return s > 0 && s <= 5;
    });
  } else if (stock === "out") {
    list = list.filter(p => Number(p["Stock"] || 0) === 0);
  }

  if (sort === "name") {
    list.sort((a,b) => (a["Name"] || "").localeCompare(b["Name"] || ""));
  } else if (sort === "priceLow") {
    list.sort((a,b) => Number(a["Price"] || 0) - Number(b["Price"] || 0));
  } else if (sort === "priceHigh") {
    list.sort((a,b) => Number(b["Price"] || 0) - Number(a["Price"] || 0));
  } else if (sort === "stockLow") {
    list.sort((a,b) => Number(a["Stock"] || 0) - Number(b["Stock"] || 0));
  } else if (sort === "stockHigh") {
    list.sort((a,b) => Number(b["Stock"] || 0) - Number(a["Stock"] || 0));
  }

  return list;
}

/* =========================
   RENDER PRODUCTS (DESKTOP + MOBILE)
========================= */
function renderProducts() {
  const tableBody = document.getElementById("productsTableBody");
  const cardList  = document.getElementById("productsCardList");
  const statusEl  = document.getElementById("statusText");
  const list = getFilteredProducts();

  tableBody.innerHTML = "";
  cardList.innerHTML  = "";

  if (!list.length) {
    tableBody.innerHTML = '<tr><td colspan="8">No products found.</td></tr>';
    return;
  }

  list.forEach(product => {

    const imgUrl =
      product["Image URL 1"] ||
      product["Image URL 2"] ||
      product["Image URL 3"] ||
      product["Image URL 4"] ||
      product["Image URL 5"] || "";

    /* DESKTOP TABLE ROW */
    const tr = document.createElement("tr");

    const tdImg = document.createElement("td");
    tdImg.className = "thumb-cell";
    const thumb = document.createElement("img");
    thumb.src = imgUrl;
    thumb.className = "thumb-img";
    thumb.style.cursor = "zoom-in";
    thumb.onclick = () => openImageLightbox(imgUrl);
    tdImg.appendChild(thumb);

    const tdSku = document.createElement("td");
    tdSku.textContent = product["SKU"] || "";

    const tdName = document.createElement("td");
    tdName.textContent = product["Name"] || "";

    const tdPrice = document.createElement("td");
    tdPrice.textContent = "‚Çπ" + (product["Price"] || "0");

    const tdStock = document.createElement("td");
    const stockVal = Number(product["Stock"] || 0);
    const badge = document.createElement("span");
    badge.className = "badge-stock";
    if (stockVal <= 0) {
      badge.classList.add("out");
      badge.textContent = "Out (" + stockVal + ")";
    } else if (stockVal <= 5) {
      badge.classList.add("low");
      badge.textContent = "Low (" + stockVal + ")";
    } else {
      badge.classList.add("ok");
      badge.textContent = "In (" + stockVal + ")";
    }
    tdStock.appendChild(badge);

    const tdCat = document.createElement("td");
    tdCat.textContent = product["Category"] || "-";

    const tdRating = document.createElement("td");
    const r = product["Rating"] || "";
    const rc = product["Review Count"] || "";
    tdRating.textContent = r ? (r + " ‚òÖ (" + rc + ")") : "‚Äì";

    const tdActions = document.createElement("td");
    const wrap = document.createElement("div");
    wrap.className = "actions";

    const btnEdit = document.createElement("button");
    btnEdit.className = "btn-small";
    btnEdit.textContent = "Edit";
    btnEdit.onclick = () => openEdit(product);

    const btnDelete = document.createElement("button");
    btnDelete.className = "btn-small danger";
    btnDelete.textContent = "Delete";
    btnDelete.onclick = () => deleteProduct(product);

    wrap.appendChild(btnEdit);
    wrap.appendChild(btnDelete);
    tdActions.appendChild(wrap);

    tr.appendChild(tdImg);
    tr.appendChild(tdSku);
    tr.appendChild(tdName);
    tr.appendChild(tdPrice);
    tr.appendChild(tdStock);
    tr.appendChild(tdCat);
    tr.appendChild(tdRating);
    tr.appendChild(tdActions);

    tableBody.appendChild(tr);


    /* MOBILE CARD */
    const card = document.createElement("div");
    card.className = "product-card";

    const mImg = document.createElement("img");
    mImg.src = imgUrl;
    mImg.className = "product-card-thumb";
    mImg.style.cursor = "zoom-in";
    mImg.onclick = () => openImageLightbox(imgUrl);

    const main = document.createElement("div");
    main.className = "product-card-main";

    const n1 = document.createElement("div");
    n1.className = "pc-name";
    n1.textContent = product["Name"] || "(no name)";

    const s1 = document.createElement("div");
    s1.className = "pc-row";
    s1.textContent = "SKU: " + (product["SKU"] || "");

    const p1 = document.createElement("div");
    p1.className = "pc-row";
    p1.textContent = "‚Çπ" + (product["Price"] || "0");

    const st = badge.cloneNode(true);

    const rowSt = document.createElement("div");
    rowSt.className = "pc-row";
    rowSt.appendChild(st);

    const rateRow = document.createElement("div");
    rateRow.className = "pc-row";
    if (r) {
      const rp = document.createElement("span");
      rp.className = "rating-pill";
      rp.textContent = r + " ‚òÖ (" + rc + ")";
      rateRow.appendChild(rp);
    }

    const actions = document.createElement("div");
    actions.style.marginTop = "4px";

    const eBtn = document.createElement("button");
    eBtn.className = "btn-small";
    eBtn.textContent = "Edit";
    eBtn.onclick = () => openEdit(product);

    const dBtn = document.createElement("button");
    dBtn.className = "btn-small danger";
    dBtn.textContent = "Delete";
    dBtn.onclick = () => deleteProduct(product);

    actions.appendChild(eBtn);
    actions.appendChild(dBtn);

    main.appendChild(n1);
    main.appendChild(s1);
    main.appendChild(p1);
    main.appendChild(rowSt);
    if (r) main.appendChild(rateRow);
    main.appendChild(actions);

    card.appendChild(mImg);
    card.appendChild(main);

    cardList.appendChild(card);
  });

  statusEl.textContent = `Showing ${list.length} of ${ALL_PRODUCTS.length} products.`;
}

/* =========================
   EDIT MODAL
========================= */
function openEdit(product) {
  CURRENT_EDIT_PRODUCT = product;

  document.getElementById("editOverlay").style.display = "flex";

  document.getElementById("editSku").value = product["SKU"] || "";
  document.getElementById("editName").value = product["Name"] || "";
  document.getElementById("editPrice").value = product["Price"] || "";
  document.getElementById("editCategory").value = product["Category"] || "";
  document.getElementById("editStock").value = product["Stock"] || "";

  document.getElementById("editLength").value = product["Length"] || "";
  document.getElementById("editWidth").value = product["Width"] || "";
  document.getElementById("editHeight").value = product["Height"] || "";
  document.getElementById("editWeight").value = product["Weight"] || "";

  document.getElementById("editDesc").value = product["Description"] || "";
  document.getElementById("editRating").value = product["Rating"] || "";
  document.getElementById("editReviewCount").value = product["Review Count"] || "";

  document.getElementById("editImg1").value = product["Image URL 1"] || "";
  document.getElementById("editImg2").value = product["Image URL 2"] || "";
  document.getElementById("editImg3").value = product["Image URL 3"] || "";
  document.getElementById("editImg4").value = product["Image URL 4"] || "";
  document.getElementById("editImg5").value = product["Image URL 5"] || "";

  document.getElementById("editVideo").value = product["Video URL"] || "";

  for (let i = 1; i <= 5; i++) syncImagePreview(i);
}

function closeEdit() {
  document.getElementById("editOverlay").style.display = "none";
  CURRENT_EDIT_PRODUCT = null;
}

/* IMAGE PREVIEW SYNC */
function syncImagePreview(i) {
  const url = document.getElementById("editImg" + i).value.trim();
  const img = document.getElementById("previewImg" + i);
  const ph  = document.getElementById("placeholder" + i);

  if (url) {
    img.src = url;
    img.style.display = "block";
    ph.style.display = "none";
  } else {
    img.style.display = "none";
    ph.style.display = "block";
  }
}

function clearImageField(i) {
  document.getElementById("editImg" + i).value = "";
  syncImagePreview(i);
}

/* IMAGE UPLOAD */
async function handleImageUpload(e, slot) {
  const file = e.target.files[0];
  if (!file) return;

  const base64 = await fileToBase64(file);

  const payload = {
    base64,
    mimeType: file.type,
    fileName: "product_" + (CURRENT_EDIT_PRODUCT?.["SKU"] || "SKU") + "_img" + slot
  };

  const res = await fetch(SCRIPT_URL + "?action=uploadMedia", {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if (data.success && data.url) {
    document.getElementById("editImg" + slot).value = data.url;
    syncImagePreview(slot);
  }

  e.target.value = "";
}

function fileToBase64(f) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(f);
  });
}

/* =========================
   SAVE EDIT
========================= */
async function saveEdit() {
  if (!CURRENT_EDIT_PRODUCT) return;

  const payload = {
    sku: document.getElementById("editSku").value.trim(),
    name: document.getElementById("editName").value.trim(),
    price: document.getElementById("editPrice").value.trim(),
    category: document.getElementById("editCategory").value.trim(),
    stock: document.getElementById("editStock").value.trim(),
    length: document.getElementById("editLength").value.trim(),
    width: document.getElementById("editWidth").value.trim(),
    height: document.getElementById("editHeight").value.trim(),
    weight: document.getElementById("editWeight").value.trim(),
    description: document.getElementById("editDesc").value.trim(),
    imageUrl1: document.getElementById("editImg1").value.trim(),
    imageUrl2: document.getElementById("editImg2").value.trim(),
    imageUrl3: document.getElementById("editImg3").value.trim(),
    imageUrl4: document.getElementById("editImg4").value.trim(),
    imageUrl5: document.getElementById("editImg5").value.trim(),
    videoUrl: document.getElementById("editVideo").value.trim()
  };

  const res = await fetch(SCRIPT_URL + "?action=updateProduct", {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if (!data.success) {
    alert("Update failed.");
    return;
  }

  const idx = ALL_PRODUCTS.findIndex(p => p["SKU"] === payload.sku);
  if (idx >= 0) ALL_PRODUCTS[idx] = { ...ALL_PRODUCTS[idx], ...payload };

  closeEdit();
  renderProducts();
}

/* =========================
   DELETE PRODUCT
========================= */
async function deleteProduct(product) {
  if (!confirm("Delete SKU " + product["SKU"] + "?")) return;

  const res = await fetch(SCRIPT_URL + "?action=deleteProduct", {
    method: "POST",
    body: JSON.stringify({ sku: product["SKU"] })
  });

  const data = await res.json();
  if (!data.success) return alert("Error deleting!");

  ALL_PRODUCTS = ALL_PRODUCTS.filter(p => p["SKU"] !== product["SKU"]);
  renderProducts();
}

/* ============================================================
   ‚≠ê‚≠ê NEW ‚Äî FULLSCREEN ZOOMABLE LIGHTBOX ENGINE ‚≠ê‚≠ê
============================================================ */
let lightboxOverlay = document.getElementById("imageLightboxOverlay");
let lightboxImg     = document.getElementById("lightboxImage");
let lightboxWrap    = document.getElementById("lightboxImageWrapper");
let lightboxClose   = document.getElementById("lightboxCloseBtn");

let scale = 1;
let startX = 0, startY = 0;
let lastX = 0, lastY = 0;
let isDragging = false;

/* OPEN LIGHTBOX */
function openImageLightbox(url) {
  scale = 1;
  lastX = 0;
  lastY = 0;
  lightboxImg.style.transform = "translate(0px,0px) scale(1)";
  lightboxImg.src = url;

  lightboxOverlay.classList.add("active");
}

/* CLOSE LIGHTBOX */
function closeLightbox() {
  lightboxOverlay.classList.remove("active");
}
lightboxOverlay.onclick = closeLightbox;
lightboxClose.onclick = closeLightbox;

/* STOP CLICK INSIDE IMAGE FROM CLOSING */
lightboxWrap.onclick = e => e.stopPropagation();

/* DRAGGING */
lightboxImg.addEventListener("mousedown", e => {
  isDragging = true;
  startX = e.clientX - lastX;
  startY = e.clientY - lastY;
});

window.addEventListener("mousemove", e => {
  if (!isDragging) return;
  lastX = e.clientX - startX;
  lastY = e.clientY - startY;
  updateTransform();
});

window.addEventListener("mouseup", () => isDragging = false);

/* MOBILE TOUCH DRAG */
lightboxImg.addEventListener("touchstart", e => {
  isDragging = true;
  const t = e.touches[0];
  startX = t.clientX - lastX;
  startY = t.clientY - lastY;
});

lightboxImg.addEventListener("touchmove", e => {
  if (!isDragging) return;
  const t = e.touches[0];
  lastX = t.clientX - startX;
  lastY = t.clientY - startY;
  updateTransform();
});

lightboxImg.addEventListener("touchend", () => isDragging = false);

/* MOUSE WHEEL ZOOM */
lightboxImg.addEventListener("wheel", e => {
  e.preventDefault();
  scale += e.deltaY * -0.001;
  scale = Math.min(Math.max(scale, 1), 4);
  updateTransform();
});

/* DOUBLE TAP / DOUBLE CLICK TO ZOOM */
let lastTap = 0;
lightboxImg.addEventListener("click", () => {
  const now = Date.now();
  if (now - lastTap < 300) {
    scale = scale === 1 ? 2.5 : 1;
    lastX = 0;
    lastY = 0;
    updateTransform();
  }
  lastTap = now;
});

/* APPLY TRANSFORM */
function updateTransform() {
  lightboxImg.style.transform =
    `translate(${lastX}px, ${lastY}px) scale(${scale})`;
}

/* ESC KEY TO CLOSE */
window.addEventListener("keydown", e => {
  if (e.key === "Escape") closeLightbox();
});

/* INIT */
window.onload = function () {
  initAdminLogin();

  for (let i = 1; i <= 5; i++) {
    document.getElementById("editImg" + i).addEventListener("input", () => {
      syncImagePreview(i);
    });
  }
};
</script>
